---
title: "Explore transcript types"
output: html_notebook
---


```{r}
library(dplyr)
library(data.table)
library(ggplot2)
library(ggpubr)
library(VennDiagram)
```



```{r}
txtbl <- fread('hg38c_txtable.tsv')
txtbl <- txtbl[chr!='chrM']
keepcodes <- unlist(strsplit("c=kjmno",''))
setnames(txtbl, c('tid', 'name', 'gbkey'), c('ref_id','txid','txtype'))
txtbl[, predicted:=grepl('^X', txid)]

## -- load a set
## loadtmap returns a list (tmap=dt, tnum=txcount)
loadtmap <- function (file=NULL) {
  tmap <- fread(file)
  tnum <- nrow(tmap)
  tmap <- tmap[ref_id!='-' & class_code %in% keepcodes ]
  tmap[txtbl, `:=` (txid=i.txid, txtype=i.txtype, biotype=i.gene_biotype, 
                    gene_name=i.gene_name, predicted=i.predicted), on=.(ref_id) ]
  tmap <- tmap[!is.na(txid)]
  #'misc_RNA' is how GenBank labels 'ncRNA' transcripts from a 'protein_coding' gene
  stopifnot(all.equal(tmap[txtype=='misc_RNA'], 
                       tmap[grepl('^[NX]R_', txid) & biotype=='protein_coding'])==T)
  tmap[txtype=='misc_RNA', txtype:='ncRNA']
  ## contingency table: predicted x coding for matching 
  tpred <- as.data.table(table(tmap[class_code=='=']$predicted))
  colnames(tpred) <- c('predicted', 'count')
  tcod <- as.data.table(table(tmap[class_code=='=']$txtype))
  colnames(tcod) <- c('coding', 'count')
  tcod[, coding:=(coding=='mRNA')]
                         
  list(tmap=tmap, tnum=tnum, tcod=tcod, tpred=tpred)
}

```

```{r}
#must be in this order: short, long, mix

genbarPlots <- function(files=NULL) {
  sd <- loadtmap(files[1])
  ld <- loadtmap(files[2])
  md <- loadtmap(files[3])
  stm <- sd$tmap[class_code=='=']
  ltm <- ld$tmap[class_code=='=']
  mtm <- md$tmap[class_code=='=']
  
  mtpred=mtm[predicted==T]$txid
  stpred=stm[predicted==T]$txid
  ltpred=ltm[predicted==T]$txid
  mtcod=mtm[txtype=='mRNA']$txid
  stcod=stm[txtype=='mRNA']$txid
  ltcod=ltm[txtype=='mRNA']$txid
  mtnc=mtm[txtype!='mRNA']$txid
  stnc=stm[txtype!='mRNA']$txid
  ltnc=ltm[txtype!='mRNA']$txid

  #library(RColorBrewer)
  #myCol <- brewer.pal(3, "Pastel2")
  myCol <- c("#ABB5E890", "#FFA28C90", "#E280E290")
  myEdgeCol <- c("#ABB5E8ff", "#FFA28Cff", "#E280E2ff")
  venn.diagram(x=list(ltm$txid, stm$txid, mtm$txid),
         category.names = c("Long", "Short", "Hybrid"),
         filename = "venn1_tm.png",
         output=T,
         height = 640 , 
         width = 640 , 
         resolution = 300,
         compression = "lzw",
         # Circles
        lwd = 2, fill = myCol, col=myEdgeCol, #lty = 'blank', 
         # Numbers
        cex = .6, fontface = "bold", fontfamily = "sans",
        # Set names
        cat.cex = 0.6, cat.fontface = "bold",
        cat.default.pos = "outer",
        cat.pos = c(-27, 27, 135),
        cat.dist = c(0.055, 0.055, 0.085),
        cat.fontfamily = "sans",
        rotation = 1
  )
    
  dpred <- rbindlist(list(sd$tpred[, assembly:='Short'], ld$tpred[, assembly:='Long'], md$tpred[, assembly:='Hybrid']))
  dpred$assembly <- factor(dpred$assembly, levels=c('Long','Short', 'Hybrid'))
  dpred[, cvar:=paste0(substr(assembly, start=1, stop=1), ifelse(predicted, 'T', 'F')) ]
  dpred[order(count), yp:=cumsum(count), by=assembly] #[predicted==F, yp:=yp-600]

  dcod <- rbindlist(list(sd$tcod[, assembly:='Short'], ld$tcod[, assembly:='Long'], md$tcod[, assembly:='Hybrid']))
  dcod$assembly <- factor(dcod$assembly, levels=c('Long', 'Short', 'Hybrid'))
  dcod[, cvar:=paste0(substr(assembly, start=1, stop=1), ifelse(coding, 'F', 'T')) ]
  dcod[order(count), yp:=cumsum(count), by=assembly]
  
  ylim=c(0, 28000)
  
  #colors=c('SF'= "#e34031", 'ST'= "#ff7061", 'LF'="#2748f3", 'LT'="#5778ff",'HF'="#9a22df", 'HT'="#ca42ef")
  colors=c('SF'= "#ff8080", 'LF'="#9090ff", 'HF'="#ea62ef", 'nc'="#90f090", 'pred'="#f0f090")
  #gpred <- 
    ggplot(dpred, aes(fill=cvar, y=count, x=assembly)) +
    geom_bar(position="stack", stat="identity") + # ggtitle("computationally predicted status")+
    geom_label(aes(label=yp, y=yp, fill=cvar), label.size=NA, vjust=0.4, color="black", size=3)+
    coord_cartesian(ylim = ylim) +
    scale_y_continuous(expand = expansion(add=c(0,0)), breaks=seq(0, 20000, 5000)) +
    scale_fill_manual(values=colors) +
    theme_bw() + xlab(NULL) + ylab(NULL) +
    theme(panel.border = element_blank(), axis.line = element_line(colour = "gray80"),
          panel.grid.minor = element_blank(), legend.position = "none")
  
  
    dmcod <-  copy(dcod)
    setnames(dmcod, 'coding', 'status')
    dmcod$type <- 'non-coding'
    dmpred <-  copy(dpred)
    setnames(dmpred, 'predicted', 'status')
    dmpred$type <- 'predicted'
    dmall <- rbindlist(list(dmcod, dmpred))
    dmall[type=='non-coding' & status==F, cvar:='nc']
    dmall[type=='predicted' & status==T, cvar:='pred']
    dmall$cvar <- factor(dmall$cvar, levels=c('LF', 'SF', 'HF', 'nc', 'pred' ))
    dmall$hj <- 0.5
    dmall$yl <- dmall$yp
    dmall[ type=='predicted' & ! cvar %in% c('nc','pred'), yl:=0]
    dmall[ type=='non-coding' & ! cvar %in% c('nc','pred'), yl:=yl-960]
    dmall[ type=='non-coding' & ! cvar %in% c('nc','pred'), hj:=-0.6]
    
    
    colors=c('LF'="#9090ff", 'SF'= "#ff9090", 'HF'="#ff70ff", 'nc'="#b6d864", 'pred'="#f4e24f")
    #colors=c('SF'= "#e34031", 'LF'="#3758f3", 'HF'="#c062c0", 'nc'="#674a5f", 'pred'="#3a722c")
    #colors=c('SF'= "#e34031", 'LF'="#3758f3", 'HF'="#c062c0", 'nc'="#5a5a5a", 'pred'="#5a924c")
    
  #gcod <- 
    #ggplot(dcod, aes(fill=cvar, y=count, x=assembly)) +
gg <-     
    ggplot(dmall[order(yp)], aes(fill=cvar, y=count, x=type)) +
    geom_bar(position="stack", stat="identity", width = 1) + # ggtitle("protein coding status")+
    scale_fill_manual(values=colors, labels = c("Long", "Short", "Hybrid", "non-coding", "predicted")) +
    facet_grid(~ assembly) +
    geom_label(data=subset(dmall, yl>0), aes(label=yp, y=yl, fill=cvar,  hjust=hj), 
               label.size=NA, vjust=0.4, color="black", size=3, show.legend = F)+
      scale_color_manual(guide="none")+
    coord_cartesian(ylim = ylim) +
    scale_y_continuous(expand = expansion(add=c(0,0)), breaks=seq(0, 20000, 5000)) +
    theme_bw() + xlab(NULL) + ylab(NULL) +
    theme(panel.border = element_blank(), axis.line = element_line(colour = "gray80"),
          panel.grid.minor = element_blank(), legend.title = element_blank(),
          strip.background = element_rect(color="white", fill="white", size=1.5)
     )
    
    
 list(gcod=gcod, gpred=gpred)
}
```


```{r}
#library(ggpattern)

options(repr.plot.width = 10, repr.plot.height = 6)

tmapfiles <- c('SRR16071313_short.tmap', 'SRR16071311_long.tmap', 'SRR16071313_SRR16071311_mix.tmap')

g1 <- genbarPlots(tmapfiles)

g2 <- genbarPlots(c('all_merged_short.tmap', 'all_merged_long.tmap', 'all_merged_mix.tmap'))

fig <- ggarrange(g1$gpred, g1$gcod, g2$gpred, g2$gcod, labels=c("A", "B", "C", "D"),
                 vjust = 0.3, ncol=2, nrow = 2)+theme(plot.margin = margin(t=0.4, unit="cm"))
fig
```


